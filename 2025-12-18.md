# Casa Teva Lead System - Development Summary

**Date:** 2025-12-18

## Overview

Today we implemented scrapers for Milanuncios and Wallapop Inmobiliaria portals, along with a per-tenant blacklist system to detect and filter hidden real estate agencies.

---

## 1. Milanuncios Scraper

### Files Created
- `scrapers/milanuncios_scraper.py` - Main scraper using Scrapy + Playwright
- `run_milanuncios_scraper.py` - CLI runner script

### Features
- Geolocation-based search using latitude/longitude coordinates
- Predefined geographic zones (La Bordeta, Salou, Tarragona, Barcelona, Madrid, Valencia, etc.)
- Anti-detection measures for Playwright (webdriver spoofing)
- Price filtering (minimum price to exclude rentals)
- Phone number normalization

### CSS Selectors Used
- Cards: `[data-testid="AD_CARD"]`
- Title links: `.ma-AdCardV2-TitleRow a`
- Price: `.ma-AdPrice-value`

### Usage
```bash
python run_milanuncios_scraper.py --zones la_bordeta salou --precio-min 5000
python run_milanuncios_scraper.py --list-zones
```

---

## 2. Wallapop Inmobiliaria Scraper

### Files Created
- `scrapers/wallapop_scraper.py` - Main scraper with blacklist integration
- `run_wallapop_scraper.py` - CLI runner script

### Features
- Geolocation search with configurable radius (km)
- **Per-tenant blacklist system** for filtering hidden agencies
- Auto-detection: users with 5+ listings are automatically blacklisted
- Detail page scraping for seller information
- Integration with Django models for persistent blacklist storage

### Key Technical Details
- Uses `PageMethod` objects for Playwright page methods (not dicts)
- Extracts items directly from Playwright page object (SPA content)
- Includes scroll actions to load lazy content

### Blacklist System
- Initial blacklist: Known agencies like "Yaencontre .."
- Auto-detection threshold: `UMBRAL_BLACKLIST = 5`
- Per-tenant storage in database
- Global blacklist (tenant=NULL) shared across all tenants

### Usage
```bash
python run_wallapop_scraper.py --zones lleida --distance 30
python run_wallapop_scraper.py --blacklist "AgenciaX" "OtraAgencia"
python run_wallapop_scraper.py --show-blacklist
```

---

## 3. Django Models (backend/apps/core/models.py)

### New Models Added

#### ZonaGeografica
Per-tenant geographic zone configuration for scraping.
```python
- tenant (FK)
- nombre, slug
- latitud, longitud, radio_km
- provincia_id (for Milanuncios)
- scrapear_milanuncios, scrapear_fotocasa, scrapear_wallapop (booleans)
- precio_minimo
```

#### UsuarioBlacklist
Users detected as hidden real estate agencies.
```python
- portal (wallapop/milanuncios/fotocasa)
- usuario_id, nombre_usuario
- tenant (FK, nullable - NULL = global)
- motivo (manual/automatico/reportado)
- num_anuncios_detectados
```

#### ContadorUsuarioPortal
Tracks listing count per user for auto-detection.
```python
- portal, usuario_id, nombre_usuario
- num_anuncios
- UMBRAL_BLACKLIST = 5
```

### Predefined Zones (ZONAS_PREESTABLECIDAS)
- Lleida: la_bordeta, lleida_ciudad
- Tarragona: tarragona_ciudad, salou, cambrils, reus
- Barcelona: barcelona_centro, hospitalet, badalona
- Madrid: madrid_centro, madrid_norte, madrid_sur
- Valencia: valencia_ciudad
- Málaga: malaga_ciudad, marbella
- Alicante: alicante_ciudad, benidorm

---

## 4. dbt Models

### Staging Models Created
- `dbt_project/models/staging/stg_milanuncios.sql`
- `dbt_project/models/staging/stg_wallapop.sql`

### Features
- Phone number normalization
- Price parsing and price-per-m2 calculation
- Zone classification
- Blacklist filtering (in stg_wallapop)
- Minimum price filter (excludes rentals)

### Marts Model Updated
- `dbt_project/models/marts/dim_leads.sql` - Now includes Milanuncios and Wallapop sources

---

## 5. Configuration Changes

### scrapers/settings.py
Fixed Playwright integration:
```python
DOWNLOAD_HANDLERS = {
    'http': 'scrapy_playwright.handler.ScrapyPlaywrightDownloadHandler',
    'https': 'scrapy_playwright.handler.ScrapyPlaywrightDownloadHandler',
}
```

---

## 6. Test Results

### Milanuncios
- La Bordeta: 5 items
- Salou: 5 items

### Wallapop
- Lleida (30km radius): 40 items

---

## 7. REST API Implementation

### Files Created
- `backend/apps/leads/serializers.py` - Lead and Nota serializers
- `backend/apps/leads/api_views.py` - LeadViewSet with CRUD and actions
- `backend/apps/leads/api_urls.py` - API URL routing for leads
- `backend/apps/core/serializers.py` - Zone, Blacklist, Counter serializers
- `backend/apps/core/api_views.py` - ViewSets for zones, blacklist, counters
- `backend/apps/core/api_urls.py` - API URL routing for core

### API Endpoints

#### Leads API (`/api/leads/`)
- `GET /api/leads/` - List leads with filters (estado, portal, zona_geografica)
- `GET /api/leads/{id}/` - Lead detail
- `PATCH /api/leads/{id}/` - Update lead
- `POST /api/leads/{id}/cambiar_estado/` - Change lead status
- `GET/POST /api/leads/{id}/notas/` - List/create notes
- `GET /api/leads/stats/` - Lead statistics

#### Zones API (`/api/core/zonas/`)
- `GET /api/core/zonas/` - List tenant zones
- `POST /api/core/zonas/` - Create zone
- `GET /api/core/zonas/{id}/` - Zone detail
- `PUT/PATCH /api/core/zonas/{id}/` - Update zone
- `DELETE /api/core/zonas/{id}/` - Delete zone
- `GET /api/core/zonas/preestablecidas/` - List predefined zones
- `POST /api/core/zonas/crear_desde_preestablecida/` - Create from predefined
- `POST /api/core/zonas/{id}/toggle_portal/` - Enable/disable portal for zone

#### Blacklist API (`/api/core/blacklist/`)
- `GET /api/core/blacklist/` - List blacklisted users
- `POST /api/core/blacklist/` - Add to blacklist
- `DELETE /api/core/blacklist/{id}/` - Remove from blacklist
- `GET /api/core/blacklist/stats/` - Blacklist statistics
- `POST /api/core/blacklist/verificar/` - Check if user is blacklisted
- `POST /api/core/blacklist/{id}/toggle_activo/` - Toggle active status

#### Counters API (`/api/core/contadores/`)
- `GET /api/core/contadores/` - List user counters
- `GET /api/core/contadores/cerca_umbral/` - Users near blacklist threshold

### Configuration
- Django REST Framework with SessionAuthentication
- django-filter for API filtering
- Pagination (25 items per page)

---

## 8. Frontend (Already Implemented)

The project includes a fully functional web frontend:

### Templates
- `templates/base.html` - Base template with sidebar/navbar
- `templates/dashboard/index.html` - Dashboard with KPIs
- `templates/leads/list.html` - Leads listing with filters
- `templates/leads/detail.html` - Lead detail view
- `templates/auth/login.html` - Login page
- `templates/profile/index.html` - User profile

### Features
- HTMX for dynamic updates
- Lead status changes without page reload
- Notes system for leads
- Statistics dashboard

---

## 9. Pending Tasks

- [ ] Deploy to Azure (App Service configured)
- [ ] Set up scheduled scraping (Azure Functions or Celery)
- [ ] Add email notifications for new leads
- [ ] Implement lead assignment workflow

---

## Architecture Summary

```
┌─────────────────────────────────────────────────────────────┐
│                      SCRAPERS                                │
├─────────────────┬─────────────────┬─────────────────────────┤
│   Milanuncios   │    Wallapop     │       Fotocasa          │
│   (Playwright)  │   (Playwright)  │     (Playwright)        │
└────────┬────────┴────────┬────────┴───────────┬─────────────┘
         │                 │                    │
         ▼                 ▼                    ▼
┌─────────────────────────────────────────────────────────────┐
│                    RAW DATA LAYER                            │
│              PostgreSQL: raw.raw_listings                    │
│              MinIO: data-lake/wallapop/...                   │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│                      dbt PIPELINE                            │
├─────────────────────────────────────────────────────────────┤
│  staging/         │  marts/           │  analytics/          │
│  - stg_fotocasa   │  - dim_leads      │  - leads_por_zona    │
│  - stg_milanuncios│                   │  - leads_por_portal  │
│  - stg_wallapop   │                   │  - metricas_diarias  │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│                    DJANGO BACKEND                            │
├─────────────────────────────────────────────────────────────┤
│  Tenant Management    │  Blacklist System (per-tenant)      │
│  Zone Configuration   │  Lead Management                     │
└─────────────────────────────────────────────────────────────┘
```

---

## Key Learnings

1. **Scrapy-Playwright Integration**: Must use `PageMethod` objects, not dicts
2. **SPA Scraping**: For React/Next.js sites, extract from Playwright page directly, not Scrapy response
3. **Anti-detection**: Use webdriver spoofing and realistic delays
4. **Per-tenant Architecture**: Blacklists should be tenant-specific to avoid cross-contamination
