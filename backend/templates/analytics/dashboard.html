{% extends 'base.html' %}

{% block title %}Analytics - Casa Teva CRM{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Analytics</h1>
            <p class="text-gray-600 dark:text-gray-400">Metricas y estadisticas del negocio inmobiliario</p>
        </div>
        <a href="{% url 'analytics:map' %}"
           class="inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors shadow-sm">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
            </svg>
            Ver Mapa
        </a>
    </div>

    <!-- Filtros -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
        <form method="get" class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Portal:</label>
                <select name="portal" onchange="this.form.submit()"
                        class="rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm">
                    <option value="">Todos</option>
                    {% for p in portales_disponibles %}
                    <option value="{{ p }}" {% if filtro_portal == p %}selected{% endif %}>{{ p|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Zona:</label>
                <select name="zona" onchange="this.form.submit()"
                        class="rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm">
                    <option value="">Todas</option>
                    {% for z in zonas_disponibles %}
                    <option value="{{ z }}" {% if filtro_zona == z %}selected{% endif %}>{{ z }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Periodo:</label>
                <select name="dias" onchange="this.form.submit()"
                        class="rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-sm">
                    <option value="">Todo el tiempo</option>
                    <option value="7" {% if filtro_dias == '7' %}selected{% endif %}>Ultimos 7 dias</option>
                    <option value="30" {% if filtro_dias == '30' %}selected{% endif %}>Ultimos 30 dias</option>
                    <option value="90" {% if filtro_dias == '90' %}selected{% endif %}>Ultimos 90 dias</option>
                </select>
            </div>
            {% if filtro_portal or filtro_zona or filtro_dias %}
            <a href="{% url 'analytics:dashboard' %}" class="text-sm text-red-600 hover:text-red-800 dark:text-red-400">
                Limpiar filtros
            </a>
            {% endif %}
        </form>
    </div>

    <!-- Proximas Visitas -->
    {% if proximas_visitas %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Proximas Visitas</h3>
            <a href="{% url 'leads:calendar' %}" class="text-sm text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300">
                Ver calendario
            </a>
        </div>
        <div class="space-y-3">
            {% for visita in proximas_visitas %}
            <a href="{% url 'leads:contact_detail' visita.contact.id %}"
               class="flex items-center justify-between p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-colors">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/50 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">{{ visita.contact.nombre|default:visita.contact.telefono }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">{{ visita.descripcion|truncatechars:40 }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm font-medium text-purple-700 dark:text-purple-300">{{ visita.fecha|date:"D d M" }}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">{{ visita.fecha|time:"H:i" }}</p>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
        <!-- Total Leads -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Total Leads</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ kpis.total_leads|default:0|floatformat:0 }}</p>
                </div>
                <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Leads Esta Semana -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Esta Semana</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ kpis.leads_ultima_semana|default:0|floatformat:0 }}</p>
                </div>
                <div class="w-10 h-10 bg-cyan-100 dark:bg-cyan-900 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-cyan-600 dark:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Tasa Conversion -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Conversion</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ kpis.tasa_conversion|default:0|floatformat:1 }}%</p>
                </div>
                <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Valor Pipeline -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Pipeline</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ kpis.valor_pipeline|default:0|floatformat:0 }}&euro;</p>
                </div>
                <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Score Medio -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Score Medio</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ kpis.score_medio|default:0|floatformat:0 }}</p>
                </div>
                <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Dias Primer Contacto -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Dias 1er Contacto</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ kpis.dias_medio_primer_contacto|default:0|floatformat:1 }}</p>
                </div>
                <div class="w-10 h-10 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Ultimos Leads Captados -->
    {% if ultimos_leads %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Ultimos Leads Captados</h3>
            <a href="{% url 'leads:contact_list' %}" class="text-sm text-primary-600 hover:text-primary-800 dark:text-primary-400">
                Ver todos
            </a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50 dark:bg-gray-700/50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Titulo</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Portal</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Zona</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Precio</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Score</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Estado</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Fecha</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for lead in ultimos_leads %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="px-3 py-2">
                            <a href="{% url 'leads:contact_detail' lead.lead_id %}" class="text-primary-600 hover:text-primary-800 dark:text-primary-400 font-medium truncate block max-w-xs">
                                {{ lead.titulo|truncatechars:40 }}
                            </a>
                        </td>
                        <td class="px-3 py-2 text-gray-600 dark:text-gray-300">{{ lead.portal|title }}</td>
                        <td class="px-3 py-2 text-gray-600 dark:text-gray-300">{{ lead.zona|default:"-" }}</td>
                        <td class="px-3 py-2 text-right font-medium text-gray-900 dark:text-white">{{ lead.precio|floatformat:0|default:"-" }}&euro;</td>
                        <td class="px-3 py-2 text-center">
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full
                                {% if lead.score >= 70 %}bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300
                                {% elif lead.score >= 40 %}bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300
                                {% else %}bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300{% endif %}">
                                {{ lead.score|default:0 }}
                            </span>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full
                                {% if lead.estado == 'NUEVO' %}bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300
                                {% elif lead.estado == 'INTERESADO' %}bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300
                                {% elif lead.estado == 'CLIENTE' %}bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300
                                {% else %}bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300{% endif %}">
                                {{ lead.estado }}
                            </span>
                        </td>
                        <td class="px-3 py-2 text-right text-gray-500 dark:text-gray-400">{{ lead.fecha_primera_captura }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Embudo de Conversion -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Embudo de Conversion</h3>
        <div class="h-80">
            <canvas id="embudoChart"></canvas>
        </div>
    </div>

    <!-- Charts Row: Leads por Dia + Evolucion Precios -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Leads por Dia -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Leads Captados (Ultimos 30 dias)</h3>
            <div class="h-72">
                <canvas id="leadsPorDiaChart"></canvas>
            </div>
        </div>

        <!-- Evolucion Precios -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Evolucion Precio Medio (Semanal)</h3>
            <div class="h-72">
                <canvas id="evolucionPreciosChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Comparativa de Portales -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Comparativa de Portales</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700/50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Portal</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Leads</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Unicos</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Contactados</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Convertidos</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">% Conv.</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Score</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Precio Medio</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for portal in comparativa_portales %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">{{ portal.portal|title }}</td>
                        <td class="px-4 py-3 text-right text-gray-600 dark:text-gray-300">{{ portal.total_leads|floatformat:0 }}</td>
                        <td class="px-4 py-3 text-right text-gray-600 dark:text-gray-300">{{ portal.leads_unicos|floatformat:0 }}</td>
                        <td class="px-4 py-3 text-right text-gray-600 dark:text-gray-300">{{ portal.contactados|floatformat:0 }}</td>
                        <td class="px-4 py-3 text-right text-gray-600 dark:text-gray-300">{{ portal.convertidos|floatformat:0 }}</td>
                        <td class="px-4 py-3 text-right">
                            <span class="px-2 py-1 text-xs font-medium rounded-full
                                {% if portal.tasa_conversion >= 10 %}bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300
                                {% elif portal.tasa_conversion >= 5 %}bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300
                                {% else %}bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300{% endif %}">
                                {{ portal.tasa_conversion|floatformat:1 }}%
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right text-gray-600 dark:text-gray-300">{{ portal.score_medio|floatformat:0 }}</td>
                        <td class="px-4 py-3 text-right font-medium text-gray-900 dark:text-white">{{ portal.precio_medio|floatformat:0 }}&euro;</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">No hay datos de portales</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts Row: Precios por Zona + Tipologia -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Precios por Zona -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Precio Medio por Zona</h3>
            <div class="h-80">
                <canvas id="preciosPorZonaChart"></canvas>
            </div>
        </div>

        <!-- Tipologia de Inmuebles -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Distribucion por Tipo de Inmueble</h3>
            <div class="h-80">
                <canvas id="tipologiaChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Tabla Precios por Zona Detallada -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Analisis de Precios por Zona</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700/50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Zona</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Inmuebles</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Precio Medio</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Precio Mediana</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Precio/m2</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for zona in precios_por_zona %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">{{ zona.zona_clasificada }}</td>
                        <td class="px-4 py-3 text-right text-gray-600 dark:text-gray-300">{{ zona.total_inmuebles|floatformat:0 }}</td>
                        <td class="px-4 py-3 text-right font-medium text-gray-900 dark:text-white">{{ zona.precio_medio|floatformat:0 }}&euro;</td>
                        <td class="px-4 py-3 text-right text-gray-600 dark:text-gray-300">{{ zona.precio_mediana|floatformat:0 }}&euro;</td>
                        <td class="px-4 py-3 text-right text-gray-600 dark:text-gray-300">{{ zona.precio_m2_medio|floatformat:0 }}&euro;/m2</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">No hay datos de zonas</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const isDark = document.documentElement.classList.contains('dark');
    const textColor = isDark ? '#9CA3AF' : '#6B7280';
    const gridColor = isDark ? '#374151' : '#E5E7EB';

    // Data from Django
    const embudoData = {{ embudo_json|safe }};
    const leadsPorDiaData = {{ leads_por_dia_json|safe }};
    const evolucionPreciosData = {{ evolucion_precios_json|safe }};
    const preciosPorZonaData = {{ precios_por_zona_json|safe }};
    const tipologiaData = {{ tipologia_json|safe }};

    // Embudo de Conversion (Horizontal Bar)
    const embudoCtx = document.getElementById('embudoChart');
    if (embudoCtx && embudoData.length > 0) {
        new Chart(embudoCtx, {
            type: 'bar',
            data: {
                labels: embudoData.map(d => d.estado),
                datasets: [{
                    label: 'Leads',
                    data: embudoData.map(d => d.total_leads),
                    backgroundColor: [
                        '#3B82F6', // Nuevo - blue
                        '#06B6D4', // En Proceso - cyan
                        '#F97316', // Contactado - orange
                        '#22C55E', // Interesado - green
                        '#EF4444', // No Interesado - red
                        '#EAB308', // En Espera - yellow
                        '#10B981', // Cliente - emerald
                        '#6B7280', // Otros - gray
                    ],
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const item = embudoData[context.dataIndex];
                                return `${context.raw} leads (${item.porcentaje.toFixed(1)}%)`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: gridColor },
                        ticks: { color: textColor }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: textColor }
                    }
                }
            }
        });
    }

    // Leads por Dia (Line Chart)
    const leadsDiaCtx = document.getElementById('leadsPorDiaChart');
    if (leadsDiaCtx && leadsPorDiaData.length > 0) {
        new Chart(leadsDiaCtx, {
            type: 'line',
            data: {
                labels: leadsPorDiaData.map(d => d.fecha),
                datasets: [{
                    label: 'Leads Captados',
                    data: leadsPorDiaData.map(d => d.leads_captados),
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        grid: { color: gridColor },
                        ticks: { color: textColor, maxTicksLimit: 10 }
                    },
                    y: {
                        grid: { color: gridColor },
                        ticks: { color: textColor },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Evolucion Precios (Line Chart)
    const preciosCtx = document.getElementById('evolucionPreciosChart');
    if (preciosCtx && evolucionPreciosData.length > 0) {
        new Chart(preciosCtx, {
            type: 'line',
            data: {
                labels: evolucionPreciosData.map(d => d.semana),
                datasets: [{
                    label: 'Precio Medio',
                    data: evolucionPreciosData.map(d => d.precio_medio),
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.3
                }, {
                    label: 'Precio Mediana',
                    data: evolucionPreciosData.map(d => d.precio_mediana),
                    borderColor: '#F59E0B',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: textColor }
                    }
                },
                scales: {
                    x: {
                        grid: { color: gridColor },
                        ticks: { color: textColor }
                    },
                    y: {
                        grid: { color: gridColor },
                        ticks: {
                            color: textColor,
                            callback: function(value) {
                                return value.toLocaleString() + ' EUR';
                            }
                        }
                    }
                }
            }
        });
    }

    // Precios por Zona (Bar Chart)
    const zonasCtx = document.getElementById('preciosPorZonaChart');
    if (zonasCtx && preciosPorZonaData.length > 0) {
        new Chart(zonasCtx, {
            type: 'bar',
            data: {
                labels: preciosPorZonaData.map(d => d.zona_clasificada),
                datasets: [{
                    label: 'Precio Medio',
                    data: preciosPorZonaData.map(d => d.precio_medio),
                    backgroundColor: '#6366F1',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: textColor, maxRotation: 45 }
                    },
                    y: {
                        grid: { color: gridColor },
                        ticks: {
                            color: textColor,
                            callback: function(value) {
                                return (value / 1000) + 'k EUR';
                            }
                        }
                    }
                }
            }
        });
    }

    // Tipologia de Inmuebles (Doughnut Chart)
    const tipologiaCtx = document.getElementById('tipologiaChart');
    if (tipologiaCtx && tipologiaData.length > 0) {
        new Chart(tipologiaCtx, {
            type: 'doughnut',
            data: {
                labels: tipologiaData.map(d => d.tipo_propiedad),
                datasets: [{
                    data: tipologiaData.map(d => d.total),
                    backgroundColor: [
                        '#3B82F6', // blue
                        '#10B981', // emerald
                        '#F59E0B', // amber
                        '#EF4444', // red
                        '#8B5CF6', // violet
                        '#EC4899', // pink
                        '#6B7280', // gray
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: textColor,
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const item = tipologiaData[context.dataIndex];
                                return `${context.label}: ${context.raw} (${item.porcentaje.toFixed(1)}%)`;
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }
</script>
{% endblock %}
