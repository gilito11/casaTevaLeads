{% extends 'base.html' %}

{% block title %}Mapa de Leads - FincaRadar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
    #map-container {
        height: 500px;
        width: 100%;
        background: #e5e7eb;
        border-radius: 0.75rem;
        position: relative;
    }
    #map {
        height: 100%;
        width: 100%;
        border-radius: 0.75rem;
    }
    .custom-marker {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        border-radius: 50%;
        color: white;
        text-align: center;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .marker-small { width: 36px; height: 36px; font-size: 12px; }
    .marker-medium { width: 44px; height: 44px; font-size: 14px; }
    .marker-large { width: 52px; height: 52px; font-size: 16px; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Mapa de Leads</h1>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Visualiza la distribucion geografica de tus leads
            </p>
        </div>
        <a href="{% url 'analytics:dashboard' %}"
           class="inline-flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-lg transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"/>
            </svg>
            Volver a Analytics
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
            <div class="flex items-center">
                <div class="p-3 rounded-lg bg-indigo-100 dark:bg-indigo-900/50">
                    <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Zonas con Leads</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_zones }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
            <div class="flex items-center">
                <div class="p-3 rounded-lg bg-green-100 dark:bg-green-900/50">
                    <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Leads</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_leads }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
            <div class="flex items-center">
                <div class="p-3 rounded-lg bg-blue-100 dark:bg-blue-900/50">
                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Leyenda</p>
                    <div class="flex items-center gap-3 mt-1">
                        <span class="flex items-center text-xs"><span class="w-3 h-3 rounded-full bg-indigo-500 mr-1"></span>1-5</span>
                        <span class="flex items-center text-xs"><span class="w-4 h-4 rounded-full bg-indigo-500 mr-1"></span>6-15</span>
                        <span class="flex items-center text-xs"><span class="w-5 h-5 rounded-full bg-indigo-500 mr-1"></span>16+</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Zones Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Detalle por Zona</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400">Haz clic en una fila para ver en el mapa</p>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700/50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Zona</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Region</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Leads</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Precio Medio</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for zone in zones_data %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer zone-row"
                        data-lat="{{ zone.lat }}" data-lon="{{ zone.lon }}" data-name="{{ zone.nombre }}">
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-white">{{ zone.nombre }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ zone.region }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-400">
                                {{ zone.total_leads }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900 dark:text-white">
                            {{ zone.precio_medio|floatformat:0 }} EUR
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                            No hay leads con ubicacion geografica
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ map_config_json|json_script:"map-config-data" }}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(function() {
    // Map configuration from Django (all in JSON to avoid locale issues)
    var mapConfig = JSON.parse(document.getElementById('map-config-data').textContent);
    var zonesData = mapConfig.zones;
    var centerLat = mapConfig.center[0];
    var centerLon = mapConfig.center[1];

    console.log('Map init - zones:', zonesData.length, 'center:', centerLat, centerLon);

    // Wait for DOM
    function initMap() {
        var mapEl = document.getElementById('map');
        if (!mapEl) {
            console.error('Map element not found!');
            return;
        }

        console.log('Map element found, dimensions:', mapEl.offsetWidth, 'x', mapEl.offsetHeight);

        // Create map
        var map = L.map('map').setView([centerLat, centerLon], 8);

        // Add tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        console.log('Map created, adding markers...');

        // Markers storage
        var markers = {};

        // Add markers
        zonesData.forEach(function(zone) {
            var size = zone.total_leads > 15 ? 52 : (zone.total_leads > 5 ? 44 : 36);
            var sizeClass = zone.total_leads > 15 ? 'marker-large' : (zone.total_leads > 5 ? 'marker-medium' : 'marker-small');

            var icon = L.divIcon({
                className: 'custom-marker ' + sizeClass,
                html: '<span>' + zone.total_leads + '</span>',
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });

            var marker = L.marker([zone.lat, zone.lon], {icon: icon}).addTo(map);

            var popup = '<div style="min-width:150px">' +
                '<strong>' + zone.nombre + '</strong><br>' +
                '<small>' + zone.region + '</small><br>' +
                '<div style="margin-top:8px">' +
                '<span style="color:#4f46e5;font-weight:bold">' + zone.total_leads + '</span> leads<br>' +
                'Precio medio: ' + zone.precio_medio.toLocaleString() + ' EUR' +
                '</div></div>';

            marker.bindPopup(popup);
            markers[zone.nombre] = marker;

            console.log('Added marker:', zone.nombre, zone.lat, zone.lon);
        });

        // Fit bounds
        if (zonesData.length > 0) {
            var bounds = L.latLngBounds(zonesData.map(function(z) { return [z.lat, z.lon]; }));
            map.fitBounds(bounds, {padding: [30, 30]});
        }

        // Fix map size
        setTimeout(function() { map.invalidateSize(); }, 200);

        // Table click
        document.querySelectorAll('.zone-row').forEach(function(row) {
            row.addEventListener('click', function() {
                var lat = parseFloat(this.dataset.lat);
                var lon = parseFloat(this.dataset.lon);
                var name = this.dataset.name;
                map.setView([lat, lon], 11);
                if (markers[name]) markers[name].openPopup();
            });
        });

        console.log('Map initialization complete');
    }

    // Initialize when ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMap);
    } else {
        initMap();
    }
})();
</script>
{% endblock %}
