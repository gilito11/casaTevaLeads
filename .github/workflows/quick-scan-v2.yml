# Quick Scan v2 - Fast new listing detection + auto-contact
# Scans page 1 only of each portal, runs dbt, queues and contacts new leads
# Schedule: DISABLED for now (manual test first)
# When ready: uncomment cron for every 2h 8AM-midnight Madrid
name: Quick Scan + Contact

on:
  # schedule:
  #   - cron: '0 6,8,10,12,14,16,18,20,22 * * *'  # Every 2h, 6-22 UTC (8AM-midnight Madrid)
  workflow_dispatch:
    inputs:
      portals:
        description: 'Portals to scan (comma-separated)'
        required: false
        default: 'fotocasa,idealista,milanuncios'
      zones:
        description: 'Zones to scan (comma-separated)'
        required: false
        default: 'salou,cambrils,tarragona,reus'
      max_contacts:
        description: 'Max contacts to process (0 = skip contact)'
        required: false
        default: '1'

env:
  DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
  TENANT_ID: 1

jobs:
  scan-and-contact:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Chrome and Xvfb
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable xvfb

      - name: Install dependencies
        run: pip install botasaurus psycopg2-binary python-decouple python-dotenv dbt-postgres requests "camoufox[geoip]" Pillow playwright

      - name: Install Camoufox browser
        run: camoufox fetch

      - name: Install Playwright browsers
        run: python -m playwright install chromium firefox

      # --- SCRAPE (page 1 only) ---

      - name: Fotocasa (page 1)
        if: contains(github.event.inputs.portals || 'fotocasa,idealista,milanuncios', 'fotocasa')
        continue-on-error: true
        run: |
          ZONES="${{ github.event.inputs.zones || 'salou,cambrils,tarragona,reus' }}"
          python run_camoufox_fotocasa_scraper.py \
            --zones ${ZONES//,/ } \
            --virtual \
            --postgres
        env:
          DATADOME_PROXY: ${{ secrets.DATADOME_PROXY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: Milanuncios (page 1)
        if: contains(github.event.inputs.portals || 'fotocasa,idealista,milanuncios', 'milanuncios')
        continue-on-error: true
        run: |
          ZONES="${{ github.event.inputs.zones || 'salou,cambrils,tarragona,reus' }}"
          python run_camoufox_milanuncios_scraper.py \
            --zones ${ZONES//,/ } \
            --max-pages 1 \
            --postgres
        env:
          DATADOME_PROXY: ${{ secrets.DATADOME_PROXY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: Idealista (page 1)
        if: contains(github.event.inputs.portals || 'fotocasa,idealista,milanuncios', 'idealista')
        continue-on-error: true
        run: |
          ZONES="${{ github.event.inputs.zones || 'salou,cambrils,tarragona,reus' }}"
          python run_camoufox_idealista_scraper.py \
            --zones ${ZONES//,/ } \
            --max-pages 1 \
            --virtual \
            --postgres
        env:
          DATADOME_PROXY: ${{ secrets.DATADOME_PROXY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      # --- TRANSFORM ---

      - name: dbt (incremental)
        run: |
          cd dbt_project
          mkdir -p /tmp/dbt_profiles
          cat > /tmp/dbt_profiles/profiles.yml << EOF
          casa_teva:
            target: prod
            outputs:
              prod:
                type: postgres
                host: ep-ancient-darkness-agqilf7l-pooler.c-2.eu-central-1.aws.neon.tech
                port: 5432
                user: neondb_owner
                password: "$DBT_PASSWORD"
                dbname: neondb
                schema: public
                threads: 4
                sslmode: require
          EOF
          dbt deps --profiles-dir /tmp/dbt_profiles || true
          dbt run --select staging marts --profiles-dir /tmp/dbt_profiles
        env:
          DBT_PASSWORD: ${{ secrets.NEON_DB_PASSWORD }}

      # --- QUEUE + CONTACT ---

      - name: Auto-queue new leads
        run: python scripts/post_scrape_auto_queue.py
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: Force-queue milanuncios test lead
        if: contains(github.event.inputs.portals || '', 'milanuncios')
        run: python scripts/test_milanuncios_login.py

      - name: Process contact queue
        if: ${{ github.event.inputs.max_contacts != '0' }}
        continue-on-error: true
        run: |
          MAX="${{ github.event.inputs.max_contacts || '1' }}"
          python scripts/process_contact_queue.py --max-contacts $MAX
        env:
          FOTOCASA_EMAIL: ${{ secrets.FOTOCASA_EMAIL }}
          FOTOCASA_PASSWORD: ${{ secrets.FOTOCASA_PASSWORD }}
          HABITACLIA_EMAIL: ${{ secrets.HABITACLIA_EMAIL }}
          HABITACLIA_PASSWORD: ${{ secrets.HABITACLIA_PASSWORD }}
          MILANUNCIOS_EMAIL: ${{ secrets.MILANUNCIOS_EMAIL }}
          MILANUNCIOS_PASSWORD: ${{ secrets.MILANUNCIOS_PASSWORD }}
          IDEALISTA_EMAIL: ${{ secrets.IDEALISTA_EMAIL }}
          IDEALISTA_PASSWORD: ${{ secrets.IDEALISTA_PASSWORD }}
          CAPTCHA_API_KEY: ${{ secrets.CAPTCHA_API_KEY }}
          DATADOME_PROXY: ${{ secrets.DATADOME_PROXY }}
          CONTACT_NAME: ${{ secrets.CONTACT_NAME }}
          CONTACT_EMAIL: ${{ secrets.CONTACT_EMAIL }}
          CONTACT_PHONE: ${{ secrets.CONTACT_PHONE }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: Summary
        run: |
          echo "## Quick Scan + Contact Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Portals: ${{ github.event.inputs.portals || 'fotocasa,idealista,milanuncios' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Zones: ${{ github.event.inputs.zones || 'salou,cambrils,tarragona,reus' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Max contacts: ${{ github.event.inputs.max_contacts || '1' }}" >> $GITHUB_STEP_SUMMARY

  notify:
    needs: scan-and-contact
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Send failure alert
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode=HTML \
            -d text="ðŸ”´ <b>Quick Scan FAILED</b>%0ACheck: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
