 # Scraper workflow - Runs on GitHub Actions, saves to Neon PostgreSQL                                                                                                                                                                       
  # Free tier: 2000 min/month                                                                                                                                                                                                                 
  name: Run Scrapers (Neon)                                                                                                                                                                                                                   
                                                                                                                                                                                                                                              
  on:                                                                                                                                                                                                                                         
    schedule:                                                                                                                                                                                                                                 
      - cron: '0 12 * * 1,3,5'                                                                                                                                                                                                                
    workflow_dispatch:                                                                                                                                                                                                                        
      inputs:                                                                                                                                                                                                                                 
        portals:                                                                                                                                                                                                                              
          description: 'Portals to scrape (comma-separated)'                                                                                                                                                                                  
          required: false                                                                                                                                                                                                                     
          default: 'habitaclia,fotocasa'                                                                                                                                                                                                      
        zones:                                                                                                                                                                                                                                
          description: 'Zones to scrape (comma-separated)'                                                                                                                                                                                    
          required: false                                                                                                                                                                                                                     
          default: 'salou,cambrils,tarragona'                                                                                                                                                                                                 
                                                                                                                                                                                                                                              
  env:                                                                                                                                                                                                                                        
    DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}                                                                                                                                                                                            
    TENANT_ID: 1                                                                                                                                                                                                                              
                                                                                                                                                                                                                                              
  jobs:                                                                                                                                                                                                                                       
    scrape:                                                                                                                                                                                                                                   
      runs-on: ubuntu-latest                                                                                                                                                                                                                  
      timeout-minutes: 60                                                                                                                                                                                                                     
      steps:                                                                                                                                                                                                                                  
        - uses: actions/checkout@v4                                                                                                                                                                                                           
        - uses: actions/setup-python@v5                                                                                                                                                                                                       
          with:                                                                                                                                                                                                                               
            python-version: '3.11'                                                                                                                                                                                                            
            cache: 'pip'                                                                                                                                                                                                                      
        - name: Install Chrome                                                                                                                                                                                                                
          run: |                                                                                                                                                                                                                              
            wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -                                                                                                                                           
            echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list                                                                                                  
            sudo apt-get update                                                                                                                                                                                                               
            sudo apt-get install -y google-chrome-stable                                                                                                                                                                                      
        - name: Install dependencies                                                                                                                                                                                                          
          run: pip install botasaurus psycopg2-binary python-decouple                                                                                                                                                                         
        - name: Run Habitaclia scraper                                                                                                                                                                                                        
          if: contains(github.event.inputs.portals || 'habitaclia,fotocasa', 'habitaclia')                                                                                                                                                    
          run: python run_habitaclia_scraper.py --zones ${{ github.event.inputs.zones || 'salou,cambrils,tarragona' }} --postgres                                                                                                             
          env:                                                                                                                                                                                                                                
            DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}                                                                                                                                                                                    
        - name: Run Fotocasa scraper                                                                                                                                                                                                          
          if: contains(github.event.inputs.portals || 'habitaclia,fotocasa', 'fotocasa')                                                                                                                                                      
          run: python run_fotocasa_scraper.py --zones ${{ github.event.inputs.zones || 'salou,cambrils,tarragona' }} --postgres                                                                                                               
          env:                                                                                                                                                                                                                                
            DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}   
